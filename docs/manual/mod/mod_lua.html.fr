<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type" />
<!--
        XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
              This file is generated from xml source: DO NOT EDIT
        XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      -->
<title>mod_lua - Serveur HTTP Apache Version 2.5</title>
<link href="../style/css/manual.css" rel="stylesheet" media="all" type="text/css" title="Main stylesheet" />
<link href="../style/css/manual-loose-100pc.css" rel="alternate stylesheet" media="all" type="text/css" title="No Sidebar - Default font size" />
<link href="../style/css/manual-print.css" rel="stylesheet" media="print" type="text/css" /><link rel="stylesheet" type="text/css" href="../style/css/prettify.css" />
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>

<link href="../images/favicon.ico" rel="shortcut icon" /></head>
<body>
<div id="page-header">
<p class="menu"><a href="../mod/">Modules</a> | <a href="../mod/quickreference.html">Directives</a> | <a href="http://wiki.apache.org/httpd/FAQ">FAQ</a> | <a href="../glossary.html">Glossaire</a> | <a href="../sitemap.html">Plan du site</a></p>
<p class="apache">Serveur HTTP Apache Version 2.5</p>
<img alt="" src="../images/feather.png" /></div>
<div class="up"><a href="./"><img title="&lt;-" alt="&lt;-" src="../images/left.gif" /></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> &gt; <a href="http://httpd.apache.org/">Serveur HTTP</a> &gt; <a href="http://httpd.apache.org/docs/">Documentation</a> &gt; <a href="../">Version 2.5</a> &gt; <a href="./">Modules</a></div>
<div id="page-content">
<div id="preamble"><h1>Module Apache mod_lua</h1>
<div class="toplang">
<p><span>Langues Disponibles: </span><a href="../en/mod/mod_lua.html" hreflang="en" rel="alternate" title="English">&nbsp;en&nbsp;</a> |
<a href="../fr/mod/mod_lua.html" title="Fran&#231;ais">&nbsp;fr&nbsp;</a></p>
</div>
<table class="module"><tr><th><a href="module-dict.html#Description">Description:</a></th><td>Fournit des points d'entr&#233;e Lua dans diff&#233;rentes parties du
traitement des requ&#234;tes httpd</td></tr>
<tr><th><a href="module-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="module-dict.html#ModuleIdentifier">Identificateur&#160;de&#160;Module:</a></th><td>lua_module</td></tr>
<tr><th><a href="module-dict.html#SourceFile">Fichier&#160;Source:</a></th><td>mod_lua.c</td></tr>
<tr><th><a href="module-dict.html#Compatibility">Compatibilit&#233;:</a></th><td>versions 2.3 et sup&#233;rieures</td></tr></table>
<h3>Sommaire</h3>

<p>Ce module permet d'ajouter au serveur des extensions sous forme de
scripts &#233;crits dans le langage de programmation Lua.
<code class="module"><a href="../mod/mod_lua.html">mod_lua</a></code> fournit de nombreuses extensions
(hooks) disponibles avec les modules natifs du serveur HTTP Apache,
comme les associations de requ&#234;tes &#224; des fichiers, la g&#233;n&#233;ration de
r&#233;ponses dynamiques, le contr&#244;le d'acc&#232;s, l'authentification et
l'autorisation.</p>

<p>Vous trouverez davantage d'informations &#224; propos du langage de
programmation Lua sur <a href="http://www.lua.org/">le site web de
Lua</a>.</p>

<div class="note"><code>mod_lua</code> est encore au stade exp&#233;rimental. Son mode
d'utilisation et son comportement pourront changer &#224; tout moment jusqu'&#224;
ce qu'il passe au stade stable, et ce m&#234;me entre deux versions stables
2.4.x. N'oublez pas de consulter le fichier CHANGES avant toute mise &#224;
jour.</div>

<div class="warning"><h3>Avertissement</h3>
<p>Ce module poss&#232;de une grande capacit&#233; d'action sur le fonctrionnement
de httpd, ce qui lui conf&#232;re une grande puissance, mais peut aussi
induire un risque de s&#233;curit&#233;. Il est d&#233;conseill&#233; d'utiliser ce module
sur un serveur partag&#233; avec des utilisateurs auxquels vous ne pouvez pas
accorder une confiance absolue, car il peut permettre de modifier le
fonctionnement interne de httpd.</p>
</div>

</div>
<div id="quickview"><h3>Sujets</h3>
<ul id="topics">
<li><img alt="" src="../images/down.gif" /> <a href="#basicconf">Configuration de base</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#writinghandlers">Ecrire des gestionnaires</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#writingauthzproviders">Ecriture de fournisseurs d'autorisation</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#writinghooks">Ecriture de fonctions d'accroche
(hooks)</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#datastructures">Structures de donn&#233;es</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#functions">M&#233;thodes de l'objet request_rec</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#logging">Fonctions de journalisation</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#apache2">Paquet apache2</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#modifying_buckets">Modification de contenu avec les filtres lua</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#databases">Connectivit&#233; aux bases de donn&#233;es</a></li>
</ul><h3 class="directives">Directives</h3>
<ul id="toc">
<li><img alt="" src="../images/down.gif" /> <a href="#luaauthzprovider">LuaAuthzProvider</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luacodecache">LuaCodeCache</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahookaccesschecker">LuaHookAccessChecker</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahookauthchecker">LuaHookAuthChecker</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahookcheckuserid">LuaHookCheckUserID</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahookfixups">LuaHookFixups</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahookinsertfilter">LuaHookInsertFilter</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahooklog">LuaHookLog</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahookmaptostorage">LuaHookMapToStorage</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahooktranslatename">LuaHookTranslateName</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luahooktypechecker">LuaHookTypeChecker</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luainherit">LuaInherit</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luainputfilter">LuaInputFilter</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luamaphandler">LuaMapHandler</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luaoutputfilter">LuaOutputFilter</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luapackagecpath">LuaPackageCPath</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luapackagepath">LuaPackagePath</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luaquickhandler">LuaQuickHandler</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luaroot">LuaRoot</a></li>
<li><img alt="" src="../images/down.gif" /> <a href="#luascope">LuaScope</a></li>
</ul>
<h3>Traitement des bugs</h3><ul class="seealso"><li><a href="https://www.apache.org/dist/httpd/CHANGES_2.4">Journal des modifications de httpd</a></li><li><a href="https://bz.apache.org/bugzilla/buglist.cgi?bug_status=__open__&amp;list_id=144532&amp;product=Apache%20httpd-2&amp;query_format=specific&amp;order=changeddate%20DESC%2Cpriority%2Cbug_severity&amp;component=mod_lua">Probl&#232;mes connus</a></li><li><a href="https://bz.apache.org/bugzilla/enter_bug.cgi?product=Apache%20httpd-2&amp;component=mod_lua">Signaler un bug</a></li></ul><h3>Voir aussi</h3>
<ul class="seealso">
<li><a href="#comments_section">Commentaires</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="basicconf" id="basicconf">Configuration de base</a><a title="Lien permanent" href="#basicconf" class="permalink">&para;</a></h2>

<p>La directive de base pour le chargement du module est</p>

<pre class="prettyprint lang-config">LoadModule lua_module modules/mod_lua.so</pre>


<p>
<code>mod_lua</code> fournit un gestionnaire nomm&#233;
<code>lua-script</code> qui peut &#234;tre utilis&#233; avec une directive
<code class="directive"><a href="../mod/core.html#sethandler">SetHandler</a></code> ou <code class="directive"><a href="../mod/mod_mime.html#addhandler">AddHandler</a></code> :</p>

<pre class="prettyprint lang-config">&lt;Files "*.lua"&gt;
    SetHandler lua-script
&lt;/Files&gt;</pre>


<p>
Ceci aura pour effet de faire traiter les requ&#234;tes pour les fichiers
dont l'extension est <code>.lua</code> par <code>mod_lua</code> en
invoquant cette fonction de <code>gestion</code> de fichier.
</p>

<p>Pour plus de d&#233;tails, voir la directive
<code class="directive">LuaMapHandler</code>.
 </p>
</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="writinghandlers" id="writinghandlers">Ecrire des gestionnaires</a><a title="Lien permanent" href="#writinghandlers" class="permalink">&para;</a></h2>
<p>Dans l'API du serveur HTTP Apache, un gestionnaire est une sorte de
point d'accroche (hook) sp&#233;cifique responsable de la g&#233;n&#233;ration de la
r&#233;ponse. <code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code>, <code class="module"><a href="../mod/mod_cgi.html">mod_cgi</a></code> et
<code class="module"><a href="../mod/mod_status.html">mod_status</a></code> sont des exemples de modules comportant un
gestionnaire.</p>

<p><code>mod_lua</code> cherche toujours &#224; invoquer une fonction Lua pour le
gestionnaire, plut&#244;t que de simplement &#233;valuer le corps d'un script dans
le style de CGI. Une fonction de gestionnaire se pr&#233;sente comme suit :</p>


<pre class="prettyprint lang-lua">
<strong>example.lua</strong><br />
-- exemple de gestionnaire

require "string"

--[[
     Il s'agit du nom de m&#233;thode par d&#233;faut pour les gestionnaires Lua ;
     voir les noms de fonctions optionnels dans la directive
     LuaMapHandler pour choisir un point d'entr&#233;e diff&#233;rent.
--]]
function handle(r)
    r.content_type = "text/plain"

    if r.method == 'GET' then
    	r:puts("Hello Lua World!\n")
        for k, v in pairs( r:parseargs() ) do
            r:puts( string.format("%s: %s\n", k, v) )
        end
    elseif r.method == 'POST' then
    	r:puts("Hello Lua World!\n")
        for k, v in pairs( r:parsebody() ) do
            r:puts( string.format("%s: %s\n", k, v) )
        end
    else
    elseif r.method == 'PUT' then
-- message d'erreur personnalis&#233;
        r:puts("Unsupported HTTP method " .. r.method)
	r.status = 405
        return apache2.OK
    else
-- message d'erreur ErrorDocument
        return 501
    end
    return apache2.OK
end</pre>


<p>
Ce gestionnaire se contente d'afficher les arguments cod&#233;s d'un uri ou
d'un formulaire dans un page au format texte.
</p>

<p>
Cela signifie que vous pouvez (et &#234;tes encourag&#233; &#224;) avoir plusieurs
gestionnaires (ou points d'entr&#233;e, ou filtres) dans le m&#234;me script.
</p>

</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="writingauthzproviders" id="writingauthzproviders">Ecriture de fournisseurs d'autorisation</a><a title="Lien permanent" href="#writingauthzproviders" class="permalink">&para;</a></h2>


<p><code class="module"><a href="../mod/mod_authz_core.html">mod_authz_core</a></code> fournit une interface d'autorisation
de haut niveau bien plus facile &#224; utiliser que dans les hooks
correspondants. Le premier argument de la directive <code class="directive"><a href="../mod/mod_authz_core.html#require">Require</a></code> permet de sp&#233;cifier le
fournisseur d'autorisation &#224; utiliser. Pour chaque directive <code class="directive"><a href="../mod/mod_authz_core.html#require">Require</a></code>,
<code class="module"><a href="../mod/mod_authz_core.html">mod_authz_core</a></code> appellera le fournisseur d'autorisation
sp&#233;cifi&#233;, le reste de la ligne constituant les param&#232;tres. Le
fournisseur consid&#233;r&#233; va alors v&#233;rifier les autorisations et fournir le
r&#233;sultat dans une valeur de retour.</p>

<p>En g&#233;n&#233;ral, le fournisseur authz est appel&#233; avant l'authentification.
S'il doit conna&#238;tre le nom d'utilisateur authentifi&#233; (ou si
l'utilisateur est appel&#233; &#224; &#234;tre authentifi&#233;), le fournisseur doit
renvoyer <code>apache2.AUTHZ_DENIED_NO_USER</code>, ce qui va
d&#233;clancher le processus d'authentification et un deuxi&#232;me appel du
fournisseur authz.</p>

<p>La fonction du fournisseur authz ci-dessous accepte deux arguments,
une adresse IP et un nom d'utilisateur. Elle autorise l'acc&#232;s dans le
cas o&#249; la requ&#234;te provient de l'adresse IP sp&#233;cifi&#233;e, ou si
l'utilisateur authentifi&#233; correspond au second argument :</p>

<pre class="prettyprint lang-lua">
<strong>authz_provider.lua</strong><br />

require 'apache2'

function authz_check_foo(r, ip, user)
    if r.useragent_ip == ip then
        return apache2.AUTHZ_GRANTED
    elseif r.user == nil then
        return apache2.AUTHZ_DENIED_NO_USER
    elseif r.user == user then
        return apache2.AUTHZ_GRANTED
    else
        return apache2.AUTHZ_DENIED
    end
end</pre>


<p>La configuration suivante enregistre cette fonction en tant que
fournisseur <code>foo</code>, et la configure por l'URL <code>/</code> :</p>
<pre class="prettyprint lang-config">LuaAuthzProvider foo authz_provider.lua authz_check_foo
&lt;Location "/"&gt;
  Require foo 10.1.2.3 john_doe
&lt;/Location&gt;</pre>


</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="writinghooks" id="writinghooks">Ecriture de fonctions d'accroche
(hooks)</a><a title="Lien permanent" href="#writinghooks" class="permalink">&para;</a></h2>

<p>Les fonctions d'accroche d&#233;terminent la mani&#232;re dont les modules (et
les scripts Lua) participent au traitement des requ&#234;tes. Chaque type
d'accroche propos&#233; par le serveur a un r&#244;le sp&#233;cifique, comme
l'association de requ&#234;tes au syst&#232;me de fichiers, le contr&#244;le d'acc&#232;s,
ou la d&#233;finition de types MIME : </p>

<table class="bordered"><tr class="header">
        <th>Phase d'accroche</th>
        <th>Directive mod_lua</th>
        <th>Description</th>
    </tr>
<tr>
        <td>Gestionnaire rapide</td>
        <td><code class="directive"><a href="#luaquickhandler">LuaQuickHandler</a></code></td>
        <td>Il s'agit de la premi&#232;re accroche appel&#233;e lorsqu'une requ&#234;te
	a &#233;t&#233; associ&#233;e &#224; un serveur ou un serveur virtuel.</td>
    </tr>
<tr class="odd">
        <td>Phase de traduction</td>
        <td><code class="directive"><a href="#luahooktranslatename">LuaHookTranslateName</a></code></td>
        <td>Cette phase traduit l'URI de la requ&#234;te en nom de fichier
	sur le syst&#232;me. Ce sont des modules comme
	<code class="module"><a href="../mod/mod_alias.html">mod_alias</a></code> et <code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> qui
	interviennent au cours de cette phase.</td>
    </tr>
<tr>
        <td>Choix du lieu de stockage de la ressource</td>
        <td><code class="directive"><a href="#luahookmaptostorage">LuaHookMapToStorage</a></code></td>
        <td>Cette phase d&#233;finit le lieu de stockage de la ressource :
	physique, en cache ou externe/mandat&#233;. Elle est assur&#233;e par les
	modules de mandat ou de mise en cache.</td>
    </tr>
<tr class="odd">
        <td>Autorisation d'acc&#232;s</td>
        <td><code class="directive"><a href="#luahookaccesschecker">LuaHookAccessChecker</a></code></td>
        <td>Cette phase v&#233;rifie si un client a l'autorisation d'acc&#232;s &#224;
	la ressource. Elle s'ex&#233;cute avant l'authentification de
	l'utisateur ; il faut donc &#234;tre prudent.
        </td>
    </tr>
<tr>
        <td>V&#233;rification de l'identifiant utilisateur</td>
        <td><code class="directive"><a href="#luahookcheckuserid">LuaHookCheckUserID</a></code></td>
        <td>Cette phase v&#233;rifie l'identifiant de l'utilisateur ayant
	fait l'objet d'une n&#233;gociation.</td>
    </tr>
<tr class="odd">
        <td>V&#233;rification de l'autorisation d'acc&#232;s</td>
        <td><code class="directive"><a href="#luahookauthchecker">LuaHookAuthChecker</a></code>
	ou
            <code class="directive"><a href="#luaauthzprovider">LuaAuthzProvider</a></code></td>
        <td>Cette phase v&#233;rifie l'autorisation d'acc&#232;s d'un utilisateur
	en fonction des ses param&#232;tres de connexion, comme
	l'identifiant, le certificat, etc...
        </td>
    </tr>
<tr>
        <td>V&#233;rification du type de la ressource</td>
        <td><code class="directive"><a href="#luahooktypechecker">LuaHookTypeChecker</a></code></td>
        <td>Cette phase assigne un type de contenu et un gestionnaire &#224;
	la ressource.</td>
    </tr>
<tr class="odd">
        <td>Derniers r&#233;glages</td>
        <td><code class="directive"><a href="#luahookfixups">LuaHookFixups</a></code></td>
        <td>C'est la derni&#232;re phase avant l'activation des gestionnaires
	de contenu. Toute modification de derni&#232;re minute &#224; la requ&#234;te
	doit &#234;tre effectu&#233;e ici.</td>
    </tr>
<tr>
        <td>Gestionnaire de contenu</td>
        <td>fichiers fx. <code>.lua</code> ou directive <code class="directive"><a href="#luamaphandler">LuaMapHandler</a></code></td>
        <td>C'est durant cette phase que le contenu est trait&#233;. Les
	fichiers sont lus, interpr&#233;t&#233;s, certains sont ex&#233;cut&#233;s, et le
	r&#233;sultat obtenu est envoy&#233; au client.</td>
    </tr>
<tr class="odd">
        <td>Journalisation</td>
        <td><code class="directive"><a href="#luahooklog">LuaHookLog</a></code></td>
        <td>Lorsqu'une requ&#234;te a &#233;t&#233; trait&#233;e, plusieurs phases de
	journalisation interviennent, et enregistrent leurs r&#233;sultats
	dans les fichiers d'erreur ou d'acc&#232;s. Mod_lua peut
	s'intercaler au d&#233;part de ce processus et ainsi contr&#244;ler la
	journalisation.</td>
    </tr>
</table>

<p>Les fonctions d'accroche re&#231;oivent l'objet de la requ&#234;te comme seul
argument (sauf LuaAuthzProvider qui re&#231;oit aussi des arguments en
provenance de la directive Require). Elles peuvent renvoyer une valeur,
selon la fonction, mais il s'agit en g&#233;n&#233;ral d'un
code d'&#233;tat HTTP ou des valeurs OK, DONE, ou DECLINED,
que vous pouvez &#233;crire dans Lua sous la forme <code>apache2.OK</code>,
<code>apache2.DONE</code>, ou <code>apache2.DECLINED</code>.</p>


<pre class="prettyprint lang-lua">
<strong>translate_name.lua</strong><br />
-- exemple d'accroche qui r&#233;&#233;crit un URI en chemin du syst&#232;me de fichiers.

require 'apache2'

function translate_name(r)
    if r.uri == "/translate-name" then
        r.filename = r.document_root .. "/find_me.txt"
        return apache2.OK
    end
    -- on ne g&#232;re pas cette URL et on donne sa chance &#224; un autre module
    return apache2.DECLINED
end</pre>



<pre class="prettyprint lang-lua">
<strong>translate_name2.lua</strong><br />
--[[ exemple d'accroche qui r&#233;&#233;crit un URI vers un autre URI. Il renvoie
	un apache2.DECLINED pour permettre &#224; un autre interpr&#233;teur d'URL de
	travailler sur la substitution, y compris l'accroche translate_name
	de base dont les tables de correspondances se basent sur DocumentRoot.

     Note: utilisez le drapeau early/late de la directive pour
     l'ex&#233;cuter avant ou apr&#232;s mod_alias.
--]]

require 'apache2'

function translate_name(r)
    if r.uri == "/translate-name" then
        r.uri = "/find_me.txt"
        return apache2.DECLINED
    end
    return apache2.DECLINED
end</pre>

</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="datastructures" id="datastructures">Structures de donn&#233;es</a><a title="Lien permanent" href="#datastructures" class="permalink">&para;</a></h2>

<dl>
<dt>request_rec</dt>
        <dd>
        <p>request_rec est consid&#233;r&#233;e en tant que donn&#233;e utilisateur.
	Elle poss&#232;de une m&#233;tatable qui vous permet d'accomplir des
	choses int&#233;ressantes. Pour la plus grande partie, elle poss&#232;de
	les m&#234;mes champs que la structure request_rec, la
	plupart d'entre eux &#233;tant accessibles en lecture et &#233;criture (le
	contenu des champs de la table peut &#234;tre modifi&#233;, mais les
	champs eux-m&#234;mes ne peuvent pas &#234;tre &#233;tablis en tant que tables
	distinctes).</p>

	<table class="bordered"><tr class="header">
          <th><strong>Nom</strong></th>
          <th><strong>Type Lua</strong></th>
          <th><strong>Modifiable</strong></th>
	  <th><strong>Description</strong></th>
        </tr>
<tr>
          <td><code>allowoverrides</code></td>
          <td>string</td>
          <td>non</td>
          <td>L'option AllowOverride s'applique &#224; la requ&#234;te courante.</td>
        </tr>
<tr class="odd">
          <td><code>ap_auth_type</code></td>
          <td>string</td>
          <td>non</td>
	  <td>Ce champ contient le type d'authentification effectu&#233;e
	  (par exemple <code>basic</code>)</td>
        </tr>
<tr>
          <td><code>args</code></td>
          <td>string</td>
          <td>oui</td>
	  <td>La cha&#238;ne de param&#232;tres de la requ&#234;te (par exemple
	  <code>foo=bar&amp;name=johnsmith</code>)</td>
        </tr>
<tr class="odd">
          <td><code>assbackwards</code></td>
          <td>boolean</td>
          <td>non</td>
	  <td>contient true s'il s'agit d'une requ&#234;te de style HTTP/0.9
	  (par exemple <code>GET /foo</code> (sans champs d'en-t&#234;te) )</td>
        </tr>
<tr>
          <td><code>auth_name</code></td>
          <td>string</td>
          <td>non</td>
          <td>La cha&#238;ne d'identification utilis&#233;e pour la v&#233;rification
	  de l'autorisation d'acc&#232;s (si elle est disponible).</td>
        </tr>
<tr class="odd">
          <td><code>banner</code></td>
          <td>string</td>
          <td>non</td>
          <td>La banni&#232;re du serveur, par exemple <code>Apache HTTP
	  Server/2.4.3 openssl/0.9.8c</code></td>
        </tr>
<tr>
          <td><code>basic_auth_pw</code></td>
          <td>string</td>
          <td>non</td>
          <td>Le mot de passe pour l'authentification de base envoy&#233;
	  avec la requ&#234;te, s'il existe</td>
        </tr>
<tr class="odd">
          <td><code>canonical_filename</code></td>
          <td>string</td>
          <td>non</td>
	  <td>Le nom de fichier canonique de la requ&#234;te</td>
        </tr>
<tr>
          <td><code>content_encoding</code></td>
          <td>string</td>
          <td>non</td>
	  <td>Le type de codage du contenu de la requ&#234;te courante</td>
        </tr>
<tr class="odd">
          <td><code>content_type</code></td>
          <td>string</td>
          <td>oui</td>
	  <td>Le type de contenu de la requ&#234;te courante, tel qu'il a &#233;t&#233;
	  d&#233;termin&#233; au cours de la phase type_check (par exemple
	  <code>image/gif</code> ou <code>text/html</code>)</td>
        </tr>
<tr>
          <td><code>context_prefix</code></td>
          <td>string</td>
          <td>non</td>
	  <td />
        </tr>
<tr class="odd">
          <td><code>context_document_root</code></td>
          <td>string</td>
          <td>non</td>
	  <td />
        </tr>
<tr>
          <td><code>document_root</code></td>
          <td>string</td>
          <td>non</td>
	  <td>La racine des documents du serveur</td>
        </tr>
<tr class="odd">
          <td><code>err_headers_out</code></td>
          <td>table</td>
          <td>non</td>
	  <td>L'en-t&#234;te MIME de l'environnement pour la r&#233;ponse, &#233;crit
	  m&#234;me en cas d'erreur et conserv&#233; pendant les redirections
	  internes</td>
        </tr>
<tr>
          <td><code>filename</code></td>
          <td>string</td>
          <td>oui</td>
	  <td>Le nom de fichier correspondant &#224; la requ&#234;te, par exemple
	  /www/example.com/foo.txt. Il peut &#234;tre modifi&#233; au cours des
	  phases translate-name ou map-to-storage du traitement de la
	  requ&#234;te pour permettre au gestionnaire par d&#233;faut (ou aux
	  gestionnaires de script) de servir une version du fichier
	  autre que celle demand&#233;e.</td>
        </tr>
<tr class="odd">
          <td><code>handler</code></td>
          <td>string</td>
          <td>oui</td>
	  <td>Le nom du <a href="../handler.html">gestionnaire</a> qui
	  doit traiter la requ&#234;te, par exemple <code>lua-script</code>
	  si elle doit &#234;tre trait&#233;e par mod_lua. Cette valeur est en
	  g&#233;n&#233;ral d&#233;finie via les directives <code class="directive"><a href="../mod/mod_mime.html#addhandler">AddHandler</a></code> ou <code class="directive"><a href="../mod/core.html#sethandler">SetHandler</a></code>, mais peut aussi l'&#234;tre
	  via mod_lua pour permettre &#224; un autre gestionnaire de traiter
	  une requ&#234;te sp&#233;cifique qui ne serait pas trait&#233;e par d&#233;faut
	  par ce dernier.
            </td>
        </tr>
<tr>
	  <td><code>headers_in</code></td>
          <td>table</td>
          <td>oui</td>
	  <td>Les en-t&#234;tes MIME de l'environnement de la requ&#234;te. Il
	  s'agit des en-t&#234;tes comme <code>Host, User-Agent,
	  Referer</code>, etc...</td>
        </tr>
<tr class="odd">
          <td><code>headers_out</code></td>
          <td>table</td>
          <td>oui</td>
	  <td>Les en-t&#234;tes MIME de l'environnement de la r&#233;ponse.</td>
        </tr>
<tr>
          <td><code>hostname</code></td>
          <td>string</td>
          <td>non</td>
	  <td>Le nom d'h&#244;te, tel que d&#233;fini par l'en-t&#234;te
	  <code>Host:</code> ou par un URI complet.</td>
        </tr>
<tr class="odd">
          <td><code>is_https</code></td>
          <td>boolean</td>
          <td>non</td>
          <td>Indique si la requ&#234;te &#224; &#233;t&#233; faite via HTTPS</td>
        </tr>
<tr>
          <td><code>is_initial_req</code></td>
          <td>boolean</td>
          <td>non</td>
          <td>Indique si la requ&#234;te courante est la requ&#234;te initiale ou
	  une sous-requ&#234;te.</td>
        </tr>
<tr class="odd">
          <td><code>limit_req_body</code></td>
          <td>number</td>
          <td>non</td>
          <td>La taille maximale du corps de la requ&#234;te, ou 0 si aucune
	  limite.</td>
        </tr>
<tr>
	<td><code>log_id</code></td>
          <td>string</td>
          <td>non</td>
	  <td>L'identifiant de la requ&#234;te dans les journaux d'acc&#232;s ou
	  d'erreur.</td>
        </tr>
<tr class="odd">
          <td><code>method</code></td>
          <td>string</td>
          <td>non</td>
	  <td>La m&#233;thode de la requ&#234;te, par exemple <code>GET</code> ou
	  <code>POST</code>.</td>
        </tr>
<tr>
          <td><code>notes</code></td>
          <td>table</td>
          <td>oui</td>
	  <td>Une liste de notes qui peuvent &#234;tre transmises d'un module
	  &#224; l'autre.</td>
        </tr>
<tr class="odd">
          <td><code>options</code></td>
          <td>string</td>
          <td>non</td>
          <td>La valeur de la directive Options pour la requ&#234;te
	  courante.</td>
        </tr>
<tr>
          <td><code>path_info</code></td>
          <td>string</td>
          <td>non</td>
	  <td>La valeur de PATH_INFO extraite de la requ&#234;te.</td>
        </tr>
<tr class="odd">
          <td><code>port</code></td>
          <td>number</td>
          <td>non</td>
          <td>Le port du serveur utilis&#233; par la requ&#234;te.</td>
        </tr>
<tr>
          <td><code>protocol</code></td>
          <td>string</td>
          <td>non</td>
	  <td>Le protocole utilis&#233;, par exemple <code>HTTP/1.1</code></td>
        </tr>
<tr class="odd">
          <td><code>proxyreq</code></td>
          <td>string</td>
          <td>oui</td>
	  <td>Indique s'il s'agit d'une requ&#234;te mandat&#233;e ou non. Cette
	  valeur est en g&#233;n&#233;ral d&#233;finie au cours de la phase
	  post_read_request/translate_name du traitement de la requ&#234;te.</td>
        </tr>
<tr>
	  <td><code>range</code></td>
          <td>string</td>
          <td>non</td>
	  <td>Le contenu de l'en-t&#234;te <code>Range:</code>.</td>
        </tr>
<tr class="odd">
          <td><code>remaining</code></td>
          <td>number</td>
          <td>non</td>
          <td>Le nombre d'octets du corps de la requ&#234;te restant &#224; lire.</td>
        </tr>
<tr>
          <td><code>server_built</code></td>
          <td>string</td>
          <td>non</td>
          <td>La date de compilation du serveur.</td>
        </tr>
<tr class="odd">
          <td><code>server_name</code></td>
          <td>string</td>
          <td>non</td>
          <td>Le nom du serveur pour cette requ&#234;te.</td>
        </tr>
<tr>
          <td><code>some_auth_required</code></td>
          <td>boolean</td>
          <td>non</td>
          <td>Indique si une autorisation est/&#233;tait requise pour cette
	  requ&#234;te.</td>
        </tr>
<tr class="odd">
          <td><code>subprocess_env</code></td>
          <td>table</td>
          <td>oui</td>
	  <td>Le jeu de variables d'environnement pour cette requ&#234;te.</td>
        </tr>
<tr>
          <td><code>started</code></td>
          <td>number</td>
          <td>non</td>
          <td>Le moment o&#249; le serveur a &#233;t&#233; (re)d&#233;marr&#233;, en secondes
	  depuis epoch (1er janvier 1970)</td>
        </tr>
<tr class="odd">
	  <td><code>status</code></td>
          <td>number</td>
          <td>oui</td>
	  <td>Le code de retour (courant) pour cette requ&#234;te, par
	  exemple <code>200</code> ou <code>404</code>.</td>
        </tr>
<tr>
          <td><code>the_request</code></td>
          <td>string</td>
          <td>non</td>
	  <td>La cha&#238;ne de la requ&#234;te telle qu'elle a &#233;t&#233; envoy&#233;e par le
	  client, par exemple <code>GET /foo/bar HTTP/1.1</code>.</td>
        </tr>
<tr class="odd">
          <td><code>unparsed_uri</code></td>
          <td>string</td>
          <td>non</td>
	  <td>La partie URI non interpr&#233;t&#233;e de la requ&#234;te</td>
        </tr>
<tr>
          <td><code>uri</code></td>
          <td>string</td>
          <td>oui</td>
	  <td>L'URI apr&#232;s interpr&#233;tation par httpd</td>
        </tr>
<tr class="odd">
          <td><code>user</code></td>
          <td>string</td>
          <td>oui</td>
	  <td>Si une authentification a &#233;t&#233; effectu&#233;e, nom de
	  l'utilisateur authentifi&#233;.</td>
        </tr>
<tr>
          <td><code>useragent_ip</code></td>
          <td>string</td>
          <td>non</td>
	  <td>L'adresse IP de l'agent qui a envoy&#233; la requ&#234;te</td>
        </tr>
</table>
	</dd>
    </dl>
</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="functions" id="functions">M&#233;thodes de l'objet request_rec</a><a title="Lien permanent" href="#functions" class="permalink">&para;</a></h2>

<p>L'objet request_rec poss&#232;de (au minimum) les m&#233;thodes suivantes :</p>

<pre class="prettyprint lang-lua">r:flush()   -- vide le tampon de sortie
            -- Renvoie true si le vidage a &#233;t&#233; effectu&#233; avec succ&#232;s,
	    -- false dans le cas contraire.

while nous_avons_des_donn&#233;es_&#224;_envoyer do
    r:puts("Bla bla bla\n") -- envoi des donn&#233;es &#224; envoyer vers le tampon
    r:flush() -- vidage du tampon (envoi au client)
    r.usleep(500000) -- mise en attente pendant 0.5 secondes et bouclage
end</pre>


<pre class="prettyprint lang-lua">r:addoutputfilter(name|function) -- ajoute un filtre en sortie

r:addoutputfilter("fooFilter") -- ins&#232;re le filtre fooFilter dans le flux de sortie</pre>


<pre class="prettyprint lang-lua">r:sendfile(filename) -- envoie un fichier entier au client en utilisant sendfile s'il est
                     -- support&#233; par la plateforme :

if use_sendfile_thing then
    r:sendfile("/var/www/large_file.img")
end</pre>


<pre class="prettyprint lang-lua">r:parseargs() -- renvoie deux tables : une table standard de couples
              -- cl&#233;/valeur pour les donn&#233;es GET simples,
              -- et une autre pour les donn&#233;es
              -- multivalu&#233;es (par exemple foo=1&amp;foo=2&amp;foo=3) :

local GET, GETMULTI = r:parseargs()
r:puts("Votre nom est : " .. GET['name'] or "Unknown")</pre>



<pre class="prettyprint lang-lua">r:parsebody()([sizeLimit]) -- interpr&#232;te le corps de la
                           -- requ&#234;te en tant que POST et renvoie
                           -- deux tables lua, comme r:parseargs(). Un
                           -- nombre optionnel peut &#234;tre fourni
                           -- pour sp&#233;cifier le nombre maximal
                           -- d'octets &#224; interpr&#233;ter. La
                           -- valeur par d&#233;faut est 8192.

local POST, POSTMULTI = r:parsebody(1024*1024)
r:puts("Votre nom est : " .. POST['name'] or "Unknown")</pre>



<pre class="prettyprint lang-lua">r:puts("bonjour", " le monde", "!") -- affichage dans le corps de la r&#233;ponse</pre>


<pre class="prettyprint lang-lua">r:write("une simple cha&#238;ne") -- affichage dans le corps de la r&#233;ponse</pre>


<pre class="prettyprint lang-lua">r:escape_html("&lt;html&gt;test&lt;/html&gt;") -- Echappe le code HTML et renvoie le r&#233;sultat</pre>


<pre class="prettyprint lang-lua">r:base64_encode(string) -- Encode une cha&#238;ne &#224; l'aide du standard de codage Base64.

local encoded = r:base64_encode("This is a test") -- returns VGhpcyBpcyBhIHRlc3Q=</pre>


<pre class="prettyprint lang-lua">r:base64_decode(string) -- D&#233;code une cha&#238;ne cod&#233;e en Base64.

local decoded = r:base64_decode("VGhpcyBpcyBhIHRlc3Q=") -- returns 'This is a test'</pre>


<pre class="prettyprint lang-lua">r:md5(string) -- Calcule et renvoie le condens&#233; MD5 d'une cha&#238;ne en mode binaire (binary safe).

local hash = r:md5("This is a test") -- returns ce114e4501d2f4e2dcea3e17b546f339</pre>


<pre class="prettyprint lang-lua">r:sha1(string) -- Calcule et renvoie le condens&#233; SHA1 d'une cha&#238;ne en mode binaire (binary safe).

local hash = r:sha1("This is a test") -- returns a54d88e06612d820bc3be72877c74f257b561b19</pre>


<pre class="prettyprint lang-lua">r:escape(string) -- Echappe une cha&#238;ne de type URL.

local url = "http://foo.bar/1 2 3 &amp; 4 + 5"
local escaped = r:escape(url) -- renvoie 'http%3a%2f%2ffoo.bar%2f1+2+3+%26+4+%2b+5'</pre>


<pre class="prettyprint lang-lua">r:unescape(string) -- D&#233;s&#233;chappe une cha&#238;ne de type URL.

local url = "http%3a%2f%2ffoo.bar%2f1+2+3+%26+4+%2b+5"
local unescaped = r:unescape(url) -- renvoie 'http://foo.bar/1 2 3 &amp; 4 + 5'</pre>


<pre class="prettyprint lang-lua">r:construct_url(string) -- Construit une URL &#224; partir d'un URI

local url = r:construct_url(r.uri)</pre>


<pre class="prettyprint lang-lua">r.mpm_query(number) -- Interroge le serveur &#224; propos de son module MPM via la requ&#234;te ap_mpm_query.

local mpm = r.mpm_query(14)
if mpm == 1 then
    r:puts("Ce serveur utilise le MPM Event")
end</pre>


<pre class="prettyprint lang-lua">r:expr(string) -- Evalue une cha&#238;ne de type <a href="../expr.html">expr</a>.

if r:expr("%{HTTP_HOST} =~ /^www/") then
    r:puts("Ce nom d'h&#244;te commence par www")
end</pre>


<pre class="prettyprint lang-lua">r:scoreboard_process(a) -- Interroge le serveur &#224; propos du
                        -- processus &#224; la position <code>a</code>.

local process = r:scoreboard_process(1)
r:puts("Le serveur 1 a comme PID " .. process.pid)</pre>


<pre class="prettyprint lang-lua">r:scoreboard_worker(a, b) -- Interroge le serveur &#224; propos du
                          -- thread <code>b</code>, dans le processus <code>a</code>.

local thread = r:scoreboard_worker(1, 1)
r:puts("L'ID du thread 1 du serveur 1 est " .. thread.tid .. " et son
&#233;tat est " .. thread.status)</pre>


<pre class="prettyprint lang-lua">r:clock() -- Renvoie l'heure courante avec une pr&#233;cision d'une microseconde.</pre>


<pre class="prettyprint lang-lua">r:requestbody(filename) -- Lit et renvoie le corps d'une requ&#234;te.
                        -- Si 'filename' est sp&#233;cifi&#233;, le
                        -- corps de requ&#234;te n'est pas
                        -- renvoy&#233;, mais sauvegard&#233; dans
                        -- le fichier correspondant.

local input = r:requestbody()
r:puts("Vous m'avez envoy&#233; le corps de requ&#234;te suivant :\n")
r:puts(input)</pre>


<pre class="prettyprint lang-lua">r:add_input_filter(filter_name) -- Ajoute le filtre en entr&#233;e 'filter_name'.</pre>


<pre class="prettyprint lang-lua">r:module_info(module_name) -- Interroge le serveur &#224; propos d'un module.

local mod = r.module_info("mod_lua.c")
if mod then
    for k, v in pairs(mod.commands) do
       r:puts( ("%s: %s\n"):format(k,v)) -- affiche toutes les directives
                                         -- impl&#233;ment&#233;es par ce module.
    end
end</pre>


<pre class="prettyprint lang-lua">r:loaded_modules() -- Renvoie une liste des modules charg&#233;s par httpd.

for k, module in pairs(r:loaded_modules()) do
    r:puts("J'ai charg&#233; le module " .. module .. "\n")
end</pre>


<pre class="prettyprint lang-lua">r:runtime_dir_relative(filename) -- G&#233;n&#232;re le nom d'un fichier run-time
                                 -- (par exemple la m&#233;moire partag&#233;e
                                 -- "file") relativement au r&#233;pertoire de run-time.</pre>


<pre class="prettyprint lang-lua">r:server_info() -- Renvoie une table contenant des informations &#224;
                -- propos du serveur, comme le nom de
                -- l'ex&#233;cutable httpd, le module mpm utilis&#233;, etc...</pre>


<pre class="prettyprint lang-lua">r:set_document_root(file_path) -- D&#233;finit la racine des documents
                               -- pour la requ&#234;te &#224; file_path.</pre>


<pre class="prettyprint lang-lua">r:add_version_component(component_string) -- Ajoute un &#233;l&#233;ment &#224;
                                          -- la banni&#232;re du serveur.</pre>


<pre class="prettyprint lang-lua">r:set_context_info(prefix, docroot) -- D&#233;finit le pr&#233;fixe et la
                                    -- racine des documents du contexte pour une requ&#234;te.</pre>


<pre class="prettyprint lang-lua">r:os_escape_path(file_path) -- Convertit un chemin du syst&#232;me de
                            -- fichiers en URL ind&#233;pendamment du syst&#232;me d'exploitation.</pre>


<pre class="prettyprint lang-lua">r:escape_logitem(string) -- Echappe une cha&#238;ne pour journalisation.</pre>


<pre class="prettyprint lang-lua">r.strcmp_match(string, pattern) -- V&#233;rifie si 'string' correspond &#224;
                                -- 'pattern' via la fonction strcmp_match (GLOBs). Par exemple, est-ce que
                                -- 'www.example.com' correspond &#224; '*.example.com' ?

local match = r.strcmp_match("foobar.com", "foo*.com")
if match then 
    r:puts("foobar.com matches foo*.com")
end</pre>


<pre class="prettyprint lang-lua">r:set_keepalive() -- D&#233;finit l'&#233;tat de persistance d'une requ&#234;te.
                  -- Renvoie true dans la mesure du possible, false dans le cas contraire.</pre>


<pre class="prettyprint lang-lua">r:make_etag() -- G&#233;n&#232;re et renvoie le etag pour la requ&#234;te courante.</pre>


<pre class="prettyprint lang-lua">r:send_interim_response(clear) -- Renvoie une r&#233;ponse d'int&#233;rim (1xx) au
                               -- client. Si 'clear' est vrai, les en-t&#234;tes disponibles
                               -- seront envoy&#233;s et effac&#233;s.</pre>


<pre class="prettyprint lang-lua">r:custom_response(status_code, string) -- G&#233;n&#232;re et d&#233;finit une r&#233;ponse
                                       -- personnalis&#233;e pour un code d'&#233;tat particulier.
                                       -- Le fonctionnement est tr&#232;s proche de celui de la directive ErrorDocument.

r:custom_response(404, "Baleted!")</pre>


<pre class="prettyprint lang-lua">r.exists_config_define(string) -- V&#233;rifie si une d&#233;finition de configuration existe.

if r.exists_config_define("FOO") then
    r:puts("httpd a probablement &#233;t&#233; lanc&#233; avec l'option -DFOO, ou FOO a
    &#233;t&#233; d&#233;fini dans la configuration")
end</pre>


<pre class="prettyprint lang-lua">r:state_query(string) -- Interroge le serveur &#224; propos de son &#233;tat.</pre>


<pre class="prettyprint lang-lua">r:stat(filename [,wanted]) -- Ex&#233;cute stat() sur un fichier, et renvoie une table contenant
                           -- des informations &#224; propos de ce fichier.

local info = r:stat("/var/www/foo.txt")
if info then
    r:puts("Ce fichier existe et a &#233;t&#233; modifi&#233; pour la derni&#232;re fois &#224; : " .. info.modified)
end</pre>


<pre class="prettyprint lang-lua">r:regex(string, pattern [,flags]) -- Ex&#233;cute une recherche &#224; base d'expression rationnelle
                                  -- sur une cha&#238;ne, et renvoie les &#233;ventuelles correspondances trouv&#233;es.

local matches = r:regex("foo bar baz", [[foo (\w+) (\S*)]])
if matches then
    r:puts("L'expression rationnelle correspond et le dernier mot
    captur&#233; ($2) est : " .. matches[2])
end

-- Exemple avec insensibilit&#233; &#224; la casse :
local matches = r:regex("FOO bar BAz", [[(foo) bar]], 1)

-- les drapeaux peuvent &#234;tre une combibaison bit &#224; bit de :
-- 0x01: insensibilit&#233; &#224; la casse
-- 0x02: recherche multiligne</pre>


<pre class="prettyprint lang-lua">r.usleep(microsecondes) -- Interrompt l'ex&#233;cution du script pendant le nombre de microsecondes sp&#233;cifi&#233;.</pre>


<pre class="prettyprint lang-lua">r:dbacquire(dbType[, dbParams]) -- Acquiert une connexion &#224; une base de donn&#233;es et renvoie une classe database.
                                -- Voir '<a href="#databases">Connectivit&#233; aux bases de donn&#233;es</a>'
				-- pour plus de d&#233;tails.</pre>


<pre class="prettyprint lang-lua">r:ivm_set("key", value) -- D&#233;fini une variable Inter-VM avec une valeur sp&#233;cifique.
                        -- Ces valeurs sont conserv&#233;es m&#234;me si la VM est
			-- arr&#234;t&#233;e ou non utilis&#233;e, et ne doivent donc &#234;tre
			-- utilis&#233;es que si MaxConnectionsPerChild &gt; 0.
			-- Les valeurs peuvent &#234;tre de type number, string
			-- ou boolean et sont stock&#233;es s&#233;par&#233;ment pour
			-- chaque processus (elles ne seront donc pas d'une
			-- grande utilit&#233; si l'on utilise le mpm prefork).
                        
r:ivm_get("key")        -- Lit le contenu d'une variable d&#233;finie via ivm_set. Renvoie
			-- le contenu de la variable si elle existe, ou nil
			-- dans le cas contraire.
                        
-- Voici un exemple de lecture/&#233;criture qui sauvegarde une variable
-- globale en dehors de la VM :
function handle(r)
    -- La premi&#232;re VM qui effectue l'appel suivant n'obtiendra aucune
    -- valeur, et devra la cr&#233;er
    local foo = r:ivm_get("cached_data")
    if not foo then
        foo = do_some_calcs() -- simulation de valeurs de retour
        r:ivm_set("cached_data", foo) -- d&#233;finition globale de la variable
    end
    r:puts("La donn&#233;e en cache est : ", foo)
end</pre>

<pre class="prettyprint lang-lua">r:htpassword(string [,algorithm [,cost]]) -- G&#233;n&#232;re un hash de mot de passe &#224; partir d'une cha&#238;ne.
                                          -- algorithm: 0 = APMD5 (d&#233;faut), 1 = SHA, 2 = BCRYPT, 3 = CRYPT.
                                          -- cost: ne s'utilise qu'avec l'algorythme BCRYPT (d&#233;faut = 5).</pre>


<pre class="prettyprint lang-lua">r:mkdir(dir [,mode]) -- Cr&#233;e un r&#233;pertoire et d&#233;finit son mode via le param&#232;tre optionnel mode.</pre>


<pre class="prettyprint lang-lua">r:mkrdir(dir [,mode]) -- Cr&#233;e des r&#233;pertoires de mani&#232;re r&#233;cursive et d&#233;finit
                      -- leur mode via le param&#232;tre optionnel mode.</pre>


<pre class="prettyprint lang-lua">r:rmdir(dir) -- Supprime un r&#233;pertoire.</pre>


<pre class="prettyprint lang-lua">r:touch(file [,mtime]) -- D&#233;finit la date de modification d'un fichier &#224; la date courante ou &#224;
                       -- la valeur optionnelle mtime en msec.</pre>


<pre class="prettyprint lang-lua">r:get_direntries(dir) -- Renvoie une table contenant toutes les entr&#233;es de r&#233;pertoires.

-- Renvoie un chemin sous forme &#233;clat&#233;e en chemin, fichier, extension
function handle(r)
  local dir = r.context_document_root
  for _, f in ipairs(r:get_direntries(dir)) do
    local info = r:stat(dir .. "/" .. f)
    if info then
      local mtime = os.date(fmt, info.mtime / 1000000)
      local ftype = (info.filetype == 2) and "[dir] " or "[file]"
      r:puts( ("%s %s %10i %s\n"):format(ftype, mtime, info.size, f) )
    end
  end
end</pre>


<pre class="prettyprint lang-lua">r.date_parse_rfc(string) -- Interpr&#232;te une cha&#238;ne date/heure et renvoie l'&#233;quivalent en secondes depuis epoche.</pre>


<pre class="prettyprint lang-lua">r:getcookie(key) -- Obtient un cookie HTTP</pre>


<pre class="prettyprint lang-lua">r:setcookie(key, value, secure, expires) -- D&#233;finit un cookie HTTP, par exemple :
r:setcookie("foo", "bar and stuff", false, os.time() + 86400)</pre>


<pre class="prettyprint lang-lua">r:wsupgrade() -- Met &#224; jour une connexion vers les WebSockets si possible (et si demand&#233;) :
if r:wsupgrade() then -- si la mise &#224; jour est possible :
    r:wswrite("Bienvenue dans les websockets!") -- &#233;crit quelque chose &#224; l'intention du client
    r:wsclose()  -- Au revoir !
end</pre>


<pre class="prettyprint lang-lua">r:wsread() -- Lit un cadre de websocket depuis une connexion vers websocket mise &#224; jour (voir ci-dessus) :
           
local line, isFinal = r:wsread() -- isFinal indique s'il s'agit du cadre final.
                                 -- dans le cas contraire, on peut lire les cadres suivants
r:wswrite("Vous avez &#233;crit : " .. line)</pre>


<pre class="prettyprint lang-lua">r:wswrite(line) -- &#233;crit un cadre vers un client WebSocket :
r:wswrite("Bonjour le Monde !")</pre>


<pre class="prettyprint lang-lua">r:wsclose() -- ferme une requ&#234;te WebSocket et l'ach&#232;ve pour httpd :

if r:wsupgrade() then
    r:wswrite("Ecrire quelque chose : ")
    local line = r:wsread() or "nothing"
    r:wswrite("Vous avez &#233;crit : " .. line);
    r:wswrite("Au revoir !")
    r:wsclose()
end</pre>

<pre class="prettyprint lang-lua">r:wspeek() -- V&#233;rifie s'il y a des donn&#233;es &#224; lire

-- Se met en sommeil tant que rien ne nous est envoy&#233; ...
while r:wspeek() == false do
   r.usleep(50000)
end
-- Il y a des donn&#233;es &#224; lire !
local line = r:wsread()</pre>



<pre class="prettyprint lang-lua">r:config() -- Extrait une arborescence de l'ensemble de
	   -- la configuration de httpd pouvant &#234;tre parcourue</pre>


<pre class="prettyprint lang-lua">r:activeconfig() -- Extrait une arborescence de la configuration active
		 -- de httpd (pour le serveur virtuel s&#233;lectionn&#233;)</pre>



</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="logging" id="logging">Fonctions de journalisation</a><a title="Lien permanent" href="#logging" class="permalink">&para;</a></h2>

<pre class="prettyprint lang-lua">	-- exemples de messages de journalisation
	r:trace1("Ceci est un message de journalisation de niveau
	trace") -- les niveaux valides vont de trace1 &#224; trace8 
        r:debug("Ceci est un message de journalisation de niveau debug")
        r:info("Ceci est un message de journalisation de niveau info")
        r:notice("Ceci est un message de journalisation de niveau notice")
        r:warn("Ceci est un message de journalisation de niveau warn")
        r:err("Ceci est un message de journalisation de niveau err")
        r:alert("Ceci est un message de journalisation de niveau alert")
        r:crit("Ceci est un message de journalisation de niveau crit")
        r:emerg("Ceci est un message de journalisation de niveau emerg")</pre>


</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="apache2" id="apache2">Paquet apache2</a><a title="Lien permanent" href="#apache2" class="permalink">&para;</a></h2>
<p>Le paquet nomm&#233; <code>apache2</code> est fourni avec (au minimum) le
contenu suivant :</p>
<dl>
  <dt>apache2.OK</dt>
  <dd>Constante interne OK. Les gestionnaires renverront cette valeur
  s'ils ont trait&#233; la requ&#234;te.</dd>
  <dt>apache2.DECLINED</dt>
  <dd>Constante interne DECLINED. Les gestionnaires renverront cette
  valeur s'ils n'ont pas l'intention de traiter la requ&#234;te.</dd>
  <dt>apache2.DONE</dt>
  <dd>Constante interne DONE.</dd>
  <dt>apache2.version</dt>
  <dd>Cha&#238;ne contenant la version du serveur HTTP Apache</dd>
  <dt>apache2.HTTP_MOVED_TEMPORARILY</dt>
  <dd>Code d'&#233;tat HTTP</dd>
  <dt>apache2.PROXYREQ_NONE, apache2.PROXYREQ_PROXY, apache2.PROXYREQ_REVERSE, apache2.PROXYREQ_RESPONSE</dt>
  <dd>Constantes internes utilis&#233;es par <code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code></dd>
  <dt>apache2.AUTHZ_DENIED, apache2.AUTHZ_GRANTED, apache2.AUTHZ_NEUTRAL, apache2.AUTHZ_GENERAL_ERROR, apache2.AUTHZ_DENIED_NO_USER</dt>
  <dd>constantes internes utilis&#233;es par <code class="module"><a href="../mod/mod_authz_core.html">mod_authz_core</a></code></dd>

</dl>
<p>Les autres codes d'&#233;tat HTTP ne sont pas encore impl&#233;ment&#233;s.</p>
</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="modifying_buckets" id="modifying_buckets">Modification de contenu avec les filtres lua</a><a title="Lien permanent" href="#modifying_buckets" class="permalink">&para;</a></h2>
    
    <p>
    Les fonctions de filtrage impl&#233;ment&#233;es via les directives <code class="directive"><a href="#luainputfilter">LuaInputFilter</a></code> ou <code class="directive"><a href="#luaoutputfilter">LuaOutputFilter</a></code> sont con&#231;ues comme des
    fonctions de 3&#232;me phase non blocantes utilisant des sous-routines
    pour suspendre et reprendre l'ex&#233;cution d'une fonction lorsque des
    paquets de donn&#233;es sont envoy&#233;s &#224; la cha&#238;ne de filtrage. La
    structure de base d'une telle fonction est :
    </p>
    <pre class="prettyprint lang-lua">function filter(r)
    -- Nous indiquons tout d'abord que nous sommes pr&#234;ts &#224; recevoir des
    -- blocs de donn&#233;es.
    -- Avant ceci, nous pouvons d&#233;finir notre environnement, tester
    -- certaines conditions, et, si nous le jugeons n&#233;cessaire, refuser le
    -- filtrage d'une requ&#234;te :
    if something_bad then
        return -- Le filtrage est saut&#233;
    end
    -- Sans se pr&#233;occuper des donn&#233;es que nous devons &#233;ventuellement ajouter, un arr&#234;t est r&#233;alis&#233; ici.
    -- Noter que les filtres de sortie sont les seuls capables d'ajouter des &#233;l&#233;ments au d&#233;but des donn&#233;es.
    -- Les filtres en entr&#233;e peuvent ajouter des &#233;l&#233;ments &#224; la fin des donn&#233;es au stade final.

    coroutine.yield([optional header to be prepended to the content])

    -- Apr&#232;s cet arr&#234;t, nous allons recevoir d'autres blocs de donn&#233;es, un par un ;
    -- nous pouvons les traiter comme il nous pla&#238;t et proc&#233;der &#224; la r&#233;ponse.
    -- Ces blocs sont conserv&#233;s dans la variable globale 'bucket', nous r&#233;alisons donc
    -- une boucle pour v&#233;rifier que 'bucket' n'est pas vide :
    while bucket ~= nil do
        local output = mangle(bucket) -- Do some stuff to the content
        coroutine.yield(output) -- Return our new content to the filter chain
    end

    -- Une fois les blocs de donn&#233;es &#233;puis&#233;s, 'bucket' est positionn&#233; &#224; une valeur vide ('nil'),
    -- ce qui va nous faire sortir de cette boucle et nous amener &#224; l'&#233;tape suivante.
    -- On peut ajouter ce qu'on veut &#224; la fin des donn&#233;es &#224; cette &#233;tape, qui constitue le dernier
    -- arr&#234;t. Les filtres d'entr&#233;e comme de sortie peuvent servir &#224; ajouter des &#233;l&#233;ments &#224; la fin
    --  des donn&#233;es &#224; cette &#233;tape.
    coroutine.yield([optional footer to be appended to the content])
end</pre>

</div><div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="section">
<h2><a name="databases" id="databases">Connectivit&#233; aux bases de donn&#233;es</a><a title="Lien permanent" href="#databases" class="permalink">&para;</a></h2>
    
    <p>Mod_lua impl&#233;mente une fonctionnalit&#233; basique de connexion aux
bases de donn&#233;es permettant d'envoyer des requ&#234;tes ou d'ex&#233;cuter des
commandes aupr&#232;s des moteurs de base de donn&#233;es les plus courants
(mySQL, PostgreSQL, FreeTDS, ODBC, SQLite, Oracle), ainsi que mod_dbd.
    </p>
    <p>L'exemple suivant montre comment se connecter &#224; une base de
donn&#233;es et extraire des informations d'une table :</p>
    <pre class="prettyprint lang-lua">function handle(r)
    -- connexion &#224; la base de donn&#233;es
    local database, err = r:dbacquire("mysql", "server=localhost,user=someuser,pass=somepass,dbname=mydb")
    if not err then
        -- S&#233;lection de certaines informations
        local results, err = database:select(r, "SELECT `name`, `age` FROM `people` WHERE 1")
        if not err then
            local rows = results(0) -- extrait tous les enregistrements en mode synchrone
            for k, row in pairs(rows) do
                r:puts( string.format("Name: %s, Age: %s&lt;br/&gt;", row[1], row[2]) )
            end
        else
            r:puts("Database query error: " .. err)
        end
        database:close()
    else
        r:puts("Connexion &#224; la base de donn&#233;es impossible : " .. err)
    end
end</pre>

    <p>
    Pour utiliser <code class="module"><a href="../mod/mod_dbd.html">mod_dbd</a></code>, sp&#233;cifiez
<code>mod_dbd</code> comme type de base de donn&#233;es, ou laissez le champ
vide :
    </p>
    <pre class="prettyprint lang-lua">local database = r:dbacquire("mod_dbd")</pre>

    <h3><a name="database_object" id="database_object">L'objet database et ses m&#233;thodes</a></h3>
        
        <p>L'objet database renvoy&#233; par <code>dbacquire</code> poss&#232;de
les m&#233;thodes suivantes :</p>
        <p><strong>S&#233;lection normale et requ&#234;te vers une base de donn&#233;es
:</strong></p>
    <pre class="prettyprint lang-lua">-- Ex&#233;cution d'une requ&#234;te et renvoie du nombre d'enregistrements
affect&#233;s :
local affected, errmsg = database:query(r, "DELETE FROM `tbl` WHERE 1")

-- Ex&#233;cution d'une requ&#234;te et renvoie du r&#233;sultat qui peut &#234;tre utilis&#233;
en mode synchrone ou asynchrone :
local result, errmsg = database:select(r, "SELECT * FROM `people` WHERE 1")</pre>

        <p><strong>Utilisation de requ&#234;tes pr&#233;par&#233;es (recommand&#233;) :</strong></p>
    <pre class="prettyprint lang-lua">-- Cr&#233;ation et ex&#233;cution d'une requ&#234;te pr&#233;par&#233;e :
local statement, errmsg = database:prepare(r, "DELETE FROM `tbl` WHERE `age` &gt; %u")
if not errmsg then
    local result, errmsg = statement:query(20) -- ex&#233;cute la requ&#234;te pour age &gt; 20
end

-- Extrait une requ&#234;te pr&#233;par&#233;e depuis une directive DBDPrepareSQL :
local statement, errmsg = database:prepared(r, "someTag")
if not errmsg then
    local result, errmsg = statement:select("John Doe", 123) -- injecte les valeurs "John Doe" et 123 dans la requ&#234;te
end</pre>

        <p><strong>Echappement de valeurs, fermeture de la base donn&#233;es,
etc...</strong></p>
    <pre class="prettyprint lang-lua">-- Echappe une valeur pour pouvoir l'utiliser dans une requ&#234;te :
local escaped = database:escape(r, [["'|blabla]])

-- Ferme une base de donn&#233;es et lib&#232;re les liens vers cette derni&#232;re :
database:close()

-- V&#233;rifie si une connexion &#224; une base de donn&#233;es est en service et
op&#233;rationnelle :
local connected = database:active()</pre>

    
    <h3><a name="result_sets" id="result_sets">Travail avec les jeux d'enregistrements renvoy&#233;s par les requ&#234;tes</a></h3>
    
    <p>Les jeux d'enregistrements renvoy&#233;s par <code>db:select</code> ou par des
requ&#234;tes pr&#233;par&#233;es cr&#233;&#233;es par <code>db:prepare</code> permettent de
s&#233;lectionner des enregistrements en mode synchrone ou
asynchrone, selon le nombre d'enregistrements sp&#233;cifi&#233; :<br />
    <code>result(0)</code> s&#233;lectionne tous les enregistrements en mode
synchrone en renvoyant une table d'enregistrements.<br />
    <code>result(-1)</code> s&#233;lectionne le prochain enregistrement disponible en
mode asynchrone.<br />
    <code>result(N)</code> s&#233;lectionne l'enregistrement num&#233;ro
<code>N</code> en mode asynchrone.
    </p>
    <pre class="prettyprint lang-lua">-- extrait un jeu d'enregistrements via une requ&#234;te r&#233;guli&#232;re :
local result, err = db:select(r, "SELECT * FROM `tbl` WHERE 1")

local rows = result(0) -- s&#233;lectionne tous les enregistrements en mode synchrone
local row = result(-1) -- s&#233;lectionne le prochain enregistrement disponible en mode asynchrone
local row = result(1234) -- s&#233;lectionne l'enregistrement 1234 en mode asynchrone
local row = result(-1, true) -- Lit l'enregistrement suivant en utilisant les noms d'enregistrements comme index.</pre>

    <p>Il est possible de construire une fonction qui renvoie une
fonction it&#233;rative permettant de traiter tous les enregistrement en mode
synchrone ou asynchrone selon la valeur de l'argument async :
    </p>
    <pre class="prettyprint lang-lua">function rows(resultset, async)
    local a = 0
    local function getnext()
        a = a + 1
        local row = resultset(-1)
        return row and a or nil, row
    end
    if not async then
        return pairs(resultset(0))
    else
        return getnext, self
    end
end

local statement, err = db:prepare(r, "SELECT * FROM `tbl` WHERE `age` &gt; %u")
if not err then
     -- s&#233;lectionne des enregistrements en mode asynchrone :
    local result, err = statement:select(20)
    if not err then
        for index, row in rows(result, true) do
            ....
        end
    end

     -- s&#233;lectionne des enregistrements en mode synchrone :
    local result, err = statement:select(20)
    if not err then
        for index, row in rows(result, false) do
            ....
        end
    end
end</pre>

    
    <h3><a name="closing_databases" id="closing_databases">Fermeture d'une connexion &#224; une base de donn&#233;es</a></h3>
        

    <p>Lorsqu'elles ne sont plus utilis&#233;es, les connexions aux bases de
donn&#233;es doivent &#234;tre ferm&#233;es avec <code>database:close()</code>. Si vous
ne les fermez pas manuellement, mod_lua les fermera peut-&#234;tre en tant
que r&#233;sidus collect&#233;s, mais si ce n'est pas le cas, vous pouvez finir
pas avoir trop de connexions vers la base de donn&#233;es inutilis&#233;es. Les
deux mesures suivantes sont pratiquement identiques :
    </p>
    <pre class="prettyprint lang-lua">-- M&#233;thode 1 : fermeture manuelle de la connexion
local database = r:dbacquire("mod_dbd")
database:close() -- c'est tout

-- M&#233;thode 2 : on laisse le collecteur de r&#233;sidus la fermer
local database = r:dbacquire("mod_dbd")
database = nil -- on coupe le lien
collectgarbage() -- fermeture de la connexion par le collecteur de r&#233;sidus</pre>

    
    <h3><a name="database_caveat" id="database_caveat">Pr&#233;cautions &#224; prendre lorsque l'on travaille avec les bases
de donn&#233;es</a></h3>
    
    <p>Bien que les fonctions <code>query</code> et <code>run</code>
soient toujours disponibles, il est recommand&#233; d'utiliser des requ&#234;tes
pr&#233;par&#233;es chaque fois que possible, afin d'une part d'optimiser les
performances (si votre connexion reste longtemps en vie), et d'autre part
minimiser le risque d'attaques par injection SQL. Les fonctions
<code>run</code> et <code>query</code> ne doivent &#234;tre utilis&#233;es que
lorsque la requ&#234;te ne contient pas de variables (requ&#234;te statique). Dans
le cas des requ&#234;tes dynamiques, utilisez <code>db:prepare</code> ou
<code>db:prepared</code>.
    </p>
    

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luaauthzprovider" id="luaauthzprovider">Directive</a> <a name="LuaAuthzProvider" id="LuaAuthzProvider">LuaAuthzProvider</a><a title="Lien permanent" href="#luaauthzprovider" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Branche une fonction fournisseur d'autorisation dans <code class="module"><a href="../mod/mod_authz_core.html">mod_authz_core</a></code>
</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaAuthzProvider provider_name /path/to/lua/script.lua function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">Compatibilit&#233;:</a></th><td>Disponible depuis la version 2.4.3 du serveur HTTP Apache</td></tr>
</table>
<p>Lorsqu'une fonction lua a &#233;t&#233; enregistr&#233;e en tant que fournisseur
d'autorisation, elle peut &#234;tre appel&#233;e via la directive <code class="directive"><a href="../mod/mod_authz_core.html#require">Require</a></code> :</p>


<pre class="prettyprint lang-config">LuaRoot /usr/local/apache2/lua
LuaAuthzProvider foo authz.lua authz_check_foo
&lt;Location "/"&gt;
  Require foo johndoe
&lt;/Location&gt;</pre>

<pre class="prettyprint lang-lua">require "apache2"
function authz_check_foo(r, who)
    if r.user ~= who then return apache2.AUTHZ_DENIED
    return apache2.AUTHZ_GRANTED
end</pre>



</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luacodecache" id="luacodecache">Directive</a> <a name="LuaCodeCache" id="LuaCodeCache">LuaCodeCache</a><a title="Lien permanent" href="#luacodecache" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Configure le cache de code compil&#233;.</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaCodeCache stat|forever|never</code></td></tr>
<tr><th><a href="directive-dict.html#Default">D&#233;faut:</a></th><td><code>LuaCodeCache stat</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table><p>
    Cette directive permet de d&#233;finir le comportement du cache de code
    en m&#233;moire. La valeur par d&#233;faut est stat ; dans ce cas, le script
    du niveau le plus haut (et pas les scripts inclus) est v&#233;rifi&#233; &#224;
    chaque fois que ce fichier est n&#233;cessaire, et est recharg&#233; si la
    date de modification est plus r&#233;cente que celle du script d&#233;j&#224;
    charg&#233;. Les autres valeurs permettent respectivement de garder le
    fichier en cache perp&#233;tuellement (forever - jamais v&#233;rifi&#233; ni
    remplac&#233;), ou de ne jamais le mettre en cache (never).</p>

    <p>En g&#233;n&#233;ral, les valeurs stat et forever sont utilis&#233;es pour un
    serveur en production, et les valeurs stat ou never pour un serveur
    en d&#233;veloppement.</p>

    <div class="example"><h3>Exemples :</h3><pre class="prettyprint lang-config">LuaCodeCache stat
LuaCodeCache forever
LuaCodeCache never</pre>
</div>


</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahookaccesschecker" id="luahookaccesschecker">Directive</a> <a name="LuaHookAccessChecker" id="LuaHookAccessChecker">LuaHookAccessChecker</a><a title="Lien permanent" href="#luahookaccesschecker" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e pour la phase access_checker du
traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookAccessChecker  /chemin/vers/lua/script.lua  hook_function_name [early|late]</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">Compatibilit&#233;:</a></th><td>Le troisi&#232;me argument optionnel est disponible depuis la
version 2.3.15 du serveur HTTP Apache.</td></tr>
</table>
<p>Ajoute votre fonction d'accroche &#224; la phase access_checker. Une
fonction d'accroche access checker renvoie en g&#233;n&#233;ral OK, DECLINED, ou
HTTP_FORBIDDEN.</p>
<div class="note"><h3>Ordonnancement</h3><p>Les arguments optionnels
   "early" ou "late" permettent de contr&#244;ler le moment auquel ce script
   s'ex&#233;cute par rapport aux autres modules.</p></div>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahookauthchecker" id="luahookauthchecker">Directive</a> <a name="LuaHookAuthChecker" id="LuaHookAuthChecker">LuaHookAuthChecker</a><a title="Lien permanent" href="#luahookauthchecker" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e pour la phase auth_checker du
traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookAuthChecker  /chemin/vers/lua/script.lua hook_function_name [early|late]</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">Compatibilit&#233;:</a></th><td>Le troisi&#232;me argument optionnel est disponible depuis la
version 2.3.15 du serveur HTTP Apache.</td></tr>
</table>
<p>Invoque une fonction lua au cours de la phase auth_checker du
traitement de la requ&#234;te. Cette directive peut s'utiliser pour
impl&#233;menter une v&#233;rification arbitraire de l'authentification et de
l'autorisation. Voici un exemple tr&#232;s simple :
</p>
<pre class="prettyprint lang-lua">require 'apache2'

-- fonction d'accroche authcheck fictive
-- Si la requ&#234;te ne contient aucune donn&#233;e d'authentification, l'en-t&#234;te
-- de la r&#233;ponse est d&#233;fini et un code 401 est renvoy&#233; afin de demander au
-- navigateur d'effectuer une authentification basique. Si la requ&#234;te
-- comporte des donn&#233;es d'authentification, elles ne sont pas vraiment
-- consult&#233;es, mais on admet la prise en compte de l'utilisateur 'foo' et
-- on la valide. On v&#233;rifie ensuite si l'utilisateur est bien 'foo' et on
-- accepte la requ&#234;te.
function authcheck_hook(r)

   -- recherche des informations d'authentification
   auth = r.headers_in['Authorization']
   if auth ~= nil then
     -- d&#233;finition d'un utilisateur par d&#233;faut
     r.user = 'foo'
   end

   if r.user == nil then
      r:debug("authcheck: user is nil, returning 401")
      r.err_headers_out['WWW-Authenticate'] = 'Basic realm="WallyWorld"'
      return 401
   elseif r.user == "foo" then
      r:debug('user foo: OK')
   else
      r:debug("authcheck: user='" .. r.user .. "'")
      r.err_headers_out['WWW-Authenticate'] = 'Basic realm="WallyWorld"'
      return 401
   end
   return apache2.OK
end</pre>

<div class="note"><h3>Ordonnancement</h3><p>Les arguments optionnels
   "early" ou "late" permettent de contr&#244;ler le moment auquel ce script
   s'ex&#233;cute par rapport aux autres modules.</p></div>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahookcheckuserid" id="luahookcheckuserid">Directive</a> <a name="LuaHookCheckUserID" id="LuaHookCheckUserID">LuaHookCheckUserID</a><a title="Lien permanent" href="#luahookcheckuserid" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e pour la phase check_user_id du
traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookCheckUserID  /path/to/lua/script.lua hook_function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahookfixups" id="luahookfixups">Directive</a> <a name="LuaHookFixups" id="LuaHookFixups">LuaHookFixups</a><a title="Lien permanent" href="#luahookfixups" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e pour la phase de correction du
traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookFixups  /chemin/vers/lua/script.lua hook_function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
<p>
    Idem LuaHookTranslateName, mais s'ex&#233;cute durant la phase de
    correction.
</p>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahookinsertfilter" id="luahookinsertfilter">Directive</a> <a name="LuaHookInsertFilter" id="LuaHookInsertFilter">LuaHookInsertFilter</a><a title="Lien permanent" href="#luahookinsertfilter" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e pour la phase insert_filter du
traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookInsertFilter  /chemin/vers/lua/script.lua hook_function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table><p>Non encore impl&#233;ment&#233;</p>
</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahooklog" id="luahooklog">Directive</a> <a name="LuaHookLog" id="LuaHookLog">LuaHookLog</a><a title="Lien permanent" href="#luahooklog" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Permet une insertion dans la phase de journalisation du
traitement d'une requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookLog  /path/to/lua/script.lua log_function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
<p>
    Ce dispositif d'insertion simple permet d'ex&#233;cuter une fonction
    lorsque httpd entre dans la phase de journalisation du traitement
    d'une requ&#234;te. Vous pouvez ainsi ajouter des donn&#233;es &#224; vos propres
    entr&#233;es de journalisation, manipuler les entr&#233;es du journal standard
    avant leur enregistrement ou emp&#234;cher l'enregistrement d'une entr&#233;e
    dans le journal. Pour emp&#234;cher l'enregistrement normal des entr&#233;es
    du journal, renvoyez simplement <code>apache2.DONE</code> dans votre
    gestionnaire de journalisation, ou au contraire, renvoyez
    <code>apache2.OK</code> pour que httpd effectue une journalisation
    normale.
</p>
<p>Exemple :</p>
<pre class="prettyprint lang-config">LuaHookLog /path/to/script.lua logger</pre>

<pre class="prettyprint lang-lua">-- /path/to/script.lua --
function logger(r)
    -- on joue &#224; pile ou face :
    -- Si on obtient 1, on &#233;crit dans notre propre journal Lua et on dit
    -- &#224; httpd de ne pas enregistrer d'entr&#233;e dans le journal standard..
    -- Si on obtient 2, on nettoie un peu les donn&#233;es avant que httpd ne
    -- les enregistre dans le journal standard.

    if math.random(1,2) == 1 then
        -- On effectue notre propre journalisation et le journal
	-- standard n'est pas aliment&#233;
        local f = io.open("/foo/secret.log", "a")
        if f then
            f:write("Quelque chose de secret est arriv&#233; &#224; " .. r.uri .. "\n")
            f:close()
        end
        return apache2.DONE -- On dit &#224; httpd de ne rien enregistrer
			    --dans le journal standard
    else
        r.uri = r.uri:gsub("somesecretstuff", "") -- nettoie les donn&#233;es
        return apache2.OK -- et httpd doit alors les enregistrer.
    end
end</pre>


</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahookmaptostorage" id="luahookmaptostorage">Directive</a> <a name="LuaHookMapToStorage" id="LuaHookMapToStorage">LuaHookMapToStorage</a><a title="Lien permanent" href="#luahookmaptostorage" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e pour la phase map_to_storage du
traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookMapToStorage  /chemin/vers/lua/script.lua hook_function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
    <p>Identique &#224; la directive
    <code class="directive">LuaHookTranslateName</code>, mais s'ex&#233;cute &#224; la
    phase map-to-storage du traitement de la requ&#234;te. Les modules comme
    mod_cache agissent pendant cette phase, ce qui permet de pr&#233;senter
    un exemple int&#233;ressant de ce que l'on peut faire ici :</p>
    <pre class="prettyprint lang-config">LuaHookMapToStorage /path/to/lua/script.lua check_cache</pre>

    <pre class="prettyprint lang-lua">require"apache2"
cached_files = {}

function read_file(filename)
    local input = io.open(filename, "r")
    if input then
        local data = input:read("*a")
        cached_files[filename] = data
        file = cached_files[filename]
        input:close()
    end
    return cached_files[filename]
end

function check_cache(r)
    if r.filename:match("%.png$") then -- Ne concerne que les fichiers PNG
        local file = cached_files[r.filename] -- V&#233;rifie les entr&#233;es du cache
        if not file then
            file = read_file(r.filename)  -- Lit le fichier vers le cache
        end
        if file then -- Si le fichier existe, on l'envoie
            r.status = 200
            r:write(file)
            r:info(("%s a &#233;t&#233; envoy&#233; au client depuis le cache"):format(r.filename))
            return apache2.DONE -- cout-circuite le gestionnaire par d&#233;faut des fichiers PNG
        end
    end
    return apache2.DECLINED -- Si nous n'avons rien eu &#224; faire, nous laissons les autres s'en charger
end</pre>


    
</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahooktranslatename" id="luahooktranslatename">Directive</a> <a name="LuaHookTranslateName" id="LuaHookTranslateName">LuaHookTranslateName</a><a title="Lien permanent" href="#luahooktranslatename" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e &#224; la phase du nom de
traduction du traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookTranslateName  /chemin/vers/lua/script.lua  nom_fonction_hook [early|late]</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">Compatibilit&#233;:</a></th><td>Le troisi&#232;me argument optionnel est disponible depuis la
version 2.3.15 du serveur HTTP Apache.</td></tr>
</table><p>
    Cette directive permet d'ajouter un point d'entr&#233;e (&#224;
    APR_HOOK_MIDDLE) &#224; la phase du nom de traduction du traitement de la
    requ&#234;te. La fonction hook accepte un seul argument, le request_rec,
    et doit renvoyer un code d'&#233;tat qui est soit un code d'erreur HTTP,
    ou une constante d&#233;finie dans le module apache2 :  apache2.OK,
    apache2.DECLINED, ou apache2.DONE.</p>

    <p>Pour ceux qui ne sont pas familiers avec les points d'entr&#233;e
    (hook), en gros, chaque hook sera invoqu&#233; jusqu'&#224; ce que l'un
    d'entre eux renvoie apache2.OK. Si un hook n'effectuer pas la
    traduction, il doit juste renvoyer apache2.DECLINED. Si le
    traitement de la requ&#234;te doit &#234;tre interrompu, la valeur renvoy&#233;e
    doit &#234;tre apache2.DONE.</p>

    <p>Exemple :</p>

<pre class="prettyprint lang-config"># httpd.conf
LuaHookTranslateName /scripts/conf/hooks.lua silly_mapper</pre>


<pre class="prettyprint lang-lua">-- /scripts/conf/hooks.lua --
require "apache2"
function silly_mapper(r)
    if r.uri == "/" then
        r.filename = "/var/www/home.lua"
        return apache2.OK
    else
        return apache2.DECLINED
    end
end</pre>


   <div class="note"><h3>Contexte</h3><p>Cette directive ne peut &#234;tre
   utilis&#233;e ni &#224; l'int&#233;rieur d'une section <code class="directive"><a href="../mod/core.html#directory">&lt;Directory&gt;</a></code> ou <code class="directive"><a href="../mod/core.html#files">&lt;Files&gt;</a></code>, ni dans un fichier htaccess.</p></div>

   <div class="note"><h3>Ordonnancement</h3><p>Les arguments optionnels
   "early" ou "late" permettent de contr&#244;ler le moment auquel ce script
   s'ex&#233;cute par rapport aux autres modules.</p></div>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luahooktypechecker" id="luahooktypechecker">Directive</a> <a name="LuaHookTypeChecker" id="LuaHookTypeChecker">LuaHookTypeChecker</a><a title="Lien permanent" href="#luahooktypechecker" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e pour la phase type_checker du
traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaHookTypeChecker  /chemin/vers/lua/script.lua hook_function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table><p>
    Cette directive fournit un point d'entr&#233;e pour la phase
    type_checker du traitement de la requ&#234;te. Cette phase
    correspond au moment o&#249; la requ&#234;te se voit assigner un type et un
    gestionnaire de contenu, et peut donc &#234;tre utilis&#233;e pour modifier le
    type et le gestionnaire en fonction de l'entr&#233;e :
    </p>
    <pre class="prettyprint lang-config">LuaHookTypeChecker "/path/to/lua/script.lua" type_checker</pre>

    <pre class="prettyprint lang-lua">    function type_checker(r)
        if r.uri:match("%.to_gif$") then -- foo.png.to_gif convient
            r.content_type = "image/gif" -- affectation du type image/gif
            r.handler = "gifWizard"      -- force le traitement de la requ&#234;te par le module gifWizard
            r.filename = r.uri:gsub("%.to_gif$", "") -- corrige le nom du fichier demand&#233;
            return apache2.OK
        end

        return apache2.DECLINED
    end</pre>

    
</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luainherit" id="luainherit">Directive</a> <a name="LuaInherit" id="LuaInherit">LuaInherit</a><a title="Lien permanent" href="#luainherit" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Contr&#244;le la mani&#232;re dont les sections de configuration
parentes sont fusionn&#233;es dans les enfants</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaInherit none|parent-first|parent-last</code></td></tr>
<tr><th><a href="directive-dict.html#Default">D&#233;faut:</a></th><td><code>LuaInherit parent-first</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">Compatibilit&#233;:</a></th><td>Versions 2.4.0 et sup&#233;rieures</td></tr>
</table><p>Par d&#233;faut, si des directives LuaHook* se trouvent dans
    des sections de configuration Directory ou Location qui se
    chevauchent, les scripts
    d&#233;finis dans les sections les plus sp&#233;cifiques s'ex&#233;cutent
    <em>apr&#232;s</em> ceux d&#233;finis dans les sections plus g&#233;n&#233;riques
    (LuaInherit parent-first). Vous pouvez inverser cet ordre, ou faire
    en sorte que le contexte parent ne s'applique pas du tout.</p>

    <p>Jusqu'aux versions 2.3.x, le comportement par d&#233;faut consistait &#224;
    ignorer les directives LuaHook* situ&#233;es dans les sections de
    configuration parentes.</p>
</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luainputfilter" id="luainputfilter">Directive</a> <a name="LuaInputFilter" id="LuaInputFilter">LuaInputFilter</a><a title="Lien permanent" href="#luainputfilter" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit une fonction Lua pour le filtrage en entr&#233;e</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaInputFilter filter_name /path/to/lua/script.lua function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">Compatibilit&#233;:</a></th><td>Disponible depuis la version 2.4.5 du serveur HTTP
Apache</td></tr>
</table>
<p>Cette directive permet d'ajouter un filtre en entr&#233;e sous la forme
d'une fonction Lua. A l'instar des filtres en sorties, les filtres en
entr&#233;e fonctionnent comme des sous-routines, intervenant dans un premier
temps avant l'envoi du contenu des tampons, puis chaque fois qu'un
paquet de donn&#233;es doit &#234;tre transmis &#224; la cha&#238;ne, et &#233;ventuellement
produisant toute donn&#233;e &#224; ajouter aux donn&#233;es en entr&#233;e. La variable
globale <code>bucket</code> contient les paquets de donn&#233;es tels qu'ils
sont transmis au script Lua :
</p>

<pre class="prettyprint lang-config">LuaInputFilter myInputFilter /www/filter.lua input_filter
&lt;Files "*.lua"&gt;
  SetInputFilter myInputFilter
&lt;/Files&gt;</pre>

<pre class="prettyprint lang-lua">--[[
    Exemple de filtre en entr&#233;e qui convertit toutes les donn&#233;es POST en
    majuscules.
]]--
function input_filter(r)
    print("luaInputFilter called") -- pour d&#233;bogage
    coroutine.yield() -- attend des paquets de donn&#233;es
    while bucket do -- Pour chaque paquet, faire ...
        local output = string.upper(bucket) -- Convertit toutes les donn&#233;es POST en majuscules
        coroutine.yield(output) -- Envoie les donn&#233;es trait&#233;es &#224; la cha&#238;ne de filtrage
    end
    -- plus aucune donn&#233;e &#224; traiter.
    coroutine.yield("&amp;filterSignature=1234") -- Ajoute une signature &#224; la fin
end</pre>

<p>
Le filtre en entr&#233;e peut interdire ou sauter un filtre s'il est
consid&#233;r&#233; comme ind&#233;sirable :
</p>
<pre class="prettyprint lang-lua">function input_filter(r)
    if not good then
        return -- Emp&#234;che tout simplement le filtrage et transmet le contenu original
    end
    coroutine.yield() -- attend des paquets de donn&#233;es
    ...               -- insert les filtres ici
end</pre>

<p>
Voir "<a href="#modifying_buckets">Modification de contenu avec les
filtres Lua</a>" pour plus de d&#233;tails.
</p>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luamaphandler" id="luamaphandler">Directive</a> <a name="LuaMapHandler" id="LuaMapHandler">LuaMapHandler</a><a title="Lien permanent" href="#luamaphandler" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Met en correspondance un chemin avec un gestionnaire lua</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaMapHandler modele-uri /chemin/vers/lua/script.lua
[nom-fonction]</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
    <p>Cette directive permet de faire correspondre un mod&#232;le d'uri avec
    une fonction de gestionnaire situ&#233;e dans un fichier sp&#233;cifique. Elle
    utilise les expressions rationnelles PCRE pour mettre en
    correspondance l'uri, et supporte les groupes de correspondance
    d'interpolation dans le chemin du fichier et le nom de la fonction.
    Prenez garde aux probl&#232;mes de s&#233;curit&#233; en &#233;crivant vos expressions
    rationnelles.</p>
   <div class="example"><h3>Exemples :</h3><pre class="prettyprint lang-config">LuaMapHandler /(\w+)/(\w+) /scripts/$1.lua handle_$2</pre>
</div>
        <p>Cette directive va faire correspondre des uri comme
	/photos/show?id=9 au fichier /scripts/photos.lua, et invoquera la
	fonction de gestionnaire handle_show au niveau de la vm lua
	apr&#232;s chargement de ce fichier.</p>

<pre class="prettyprint lang-config">LuaMapHandler /bingo /scripts/wombat.lua</pre>

        <p>Cette directive invoquera la fonction "handle" qui est la
	valeur par d&#233;faut si aucun nom de fonction sp&#233;cifique n'est
	sp&#233;cifi&#233;.</p>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luaoutputfilter" id="luaoutputfilter">Directive</a> <a name="LuaOutputFilter" id="LuaOutputFilter">LuaOutputFilter</a><a title="Lien permanent" href="#luaoutputfilter" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit une fonction Lua pour le filtrage de contenu en
sortie</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaOutputFilter filter_name /path/to/lua/script.lua function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">Compatibilit&#233;:</a></th><td>Disponible &#224; partir de la version 2.4.5 du serveur HTTP
Apache</td></tr>
</table>
<p>&gt;Cette directive permet d'ajouter un filtre en sortie sous la forme
d'une fonction Lua. A l'instar des filtres en sorties, les filtres en
entr&#233;e fonctionnent comme des sous-routines, intervenant dans un premier
temps avant l'envoi du contenu des tampons, puis chaque fois qu'un
paquet de donn&#233;es doit &#234;tre transmis &#224; la cha&#238;ne, et &#233;ventuellement
produisant toute donn&#233;e &#224; ajouter aux donn&#233;es en sortie. La variable
globale <code>bucket</code> contient les paquets de donn&#233;es tels qu'ils
sont transmis au script Lua :
</p>

<pre class="prettyprint lang-config">LuaOutputFilter myOutputFilter /www/filter.lua output_filter
&lt;Files "*.lua"&gt;
  SetOutputFilter myOutputFilter
&lt;/Files&gt;</pre>

<pre class="prettyprint lang-lua">--[[
    Exemple de filtre en sortie qui &#233;chappe toutes les entit&#233;s HTML en
    sortie
]]--
function output_filter(r)
    coroutine.yield("(Handled by myOutputFilter)&lt;br/&gt;\n") -- Ajoute des donn&#233;es au d&#233;but de la sortie,
                                                                -- puis attend des paquets de donn&#233;es &#224; traiter
    while bucket do -- Pour chaque paquet, faire ...
        local output = r:escape_html(bucket) -- Echappe les donn&#233;es en sortie
        coroutine.yield(output) -- Envoie les donn&#233;es trait&#233;es &#224; la cha&#238;ne
    end
    -- plus aucune donn&#233;e &#224; traiter.
end</pre>

<p>
Comme les filres en entr&#233;e, le filtre en sortie peut interdire ou sauter un filtre s'il est
consid&#233;r&#233; comme ind&#233;sirable :
</p>
<pre class="prettyprint lang-lua">function output_filter(r)
    if not r.content_type:match("text/html") then
        return -- Emp&#234;che tout simplement le filtrage et transmet le contenu original
    end
    coroutine.yield() -- attend des paquets de donn&#233;es
    ...               -- insert les filtres ici
end</pre>

<div class="note"><h3>Les filtres Lua avec <code class="module"><a href="../mod/mod_filter.html">mod_filter</a></code></h3>
<p>Lorsqu'on utilise un filtre Lua comme fournisseur sous-jacent via la
directive <code class="directive"><a href="../mod/mod_filter.html#filterprovider">FilterProvider</a></code>, le
filtrage ne fonctionnera que si <var>filter-name</var> est identique &#224;
<var>provider-name</var>.
</p> </div>

<p>
Voir "<a href="#modifying_buckets">Modification de contenu avec les
filtres Lua</a>" pour plus de d&#233;tails.
</p>


</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luapackagecpath" id="luapackagecpath">Directive</a> <a name="LuaPackageCPath" id="LuaPackageCPath">LuaPackageCPath</a><a title="Lien permanent" href="#luapackagecpath" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Ajoute un r&#233;pertoire au package.cpath de lua</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaPackageCPath /chemin/vers/include/?.soa</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
    <p>Cette directive permet d'ajouter un chemin &#224; la liste des chemins
    de recherche des biblioth&#232;ques partag&#233;es de lua. Ceci modifie le
    package.cpath dans les vms lua.</p>


</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luapackagepath" id="luapackagepath">Directive</a> <a name="LuaPackagePath" id="LuaPackagePath">LuaPackagePath</a><a title="Lien permanent" href="#luapackagepath" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Ajoute un r&#233;pertoire au package.path de lua</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaPackagePath /chemin/vers/include/?.lua</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table><p>Cette directive permet d'ajouter un chemin &#224; la liste des
    chemins de recherche du module lua. Elle suit les m&#234;mes conventions
    que lua. Ceci modifie le package.path dans les vms lua.</p>

    <div class="example"><h3>Exemples :</h3><pre class="prettyprint lang-config">LuaPackagePath /scripts/lib/?.lua
LuaPackagePath /scripts/lib/?/init.lua</pre>
</div>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luaquickhandler" id="luaquickhandler">Directive</a> <a name="LuaQuickHandler" id="LuaQuickHandler">LuaQuickHandler</a><a title="Lien permanent" href="#luaquickhandler" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Fournit un point d'entr&#233;e pour la gestion rapide du
traitement de la requ&#234;te</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaQuickHandler /path/to/script.lua hook_function_name</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
    <p>Cette phase s'ex&#233;cute juste apr&#232;s l'attribution de la requ&#234;te &#224;
    un serveur virtuel, et permet d'effectuer certains traitements avant
    le d&#233;roulement des autres phases, ou de servir une requ&#234;te sans
    avoir &#224; la traduire, l'associer &#224; un espace de stockage, etc...
    Comme cette phase s'ex&#233;cute avant toute autre, les directives telles
    que <code class="directive"><a href="../mod/core.html#location">&lt;Location&gt;</a></code> ou
    <code class="directive"><a href="../mod/core.html#directory">&lt;Directory&gt;</a></code> ne
    sont pas encore prises en compte, car Les URI n'ont pas encore &#233;t&#233;
    enti&#232;rement interpr&#233;t&#233;s.
    </p>
   <div class="note"><h3>Contexte</h3><p>Cette directive ne peut &#234;tre
   utilis&#233;e ni &#224; l'int&#233;rieur d'une section <code class="directive"><a href="../mod/core.html#directory">&lt;Directory&gt;</a></code> ou <code class="directive"><a href="../mod/core.html#files">&lt;Files&gt;</a></code>, ni dans un fichier htaccess.</p></div>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luaroot" id="luaroot">Directive</a> <a name="LuaRoot" id="LuaRoot">LuaRoot</a><a title="Lien permanent" href="#luaroot" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Sp&#233;cifie le chemin de base pour la r&#233;solution des chemins
relatifs dans les directives de mod_lua</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaRoot /chemin/vers/un/r&#233;pertoire</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
    <p>Cette directive permet de sp&#233;cifier le chemin de base qui sera
    utilis&#233; pour &#233;valuer tous les chemins relatifs dans mod_lua. En
    l'absence de cette directive, les chemins relatifs sont r&#233;solus par
    rapport au r&#233;pertoire de travail courant, ce qui ne sera pas
    toujours appropri&#233; pour un serveur.</p>

</div>
<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
<div class="directive-section"><h2><a name="luascope" id="luascope">Directive</a> <a name="LuaScope" id="LuaScope">LuaScope</a><a title="Lien permanent" href="#luascope" class="permalink">&para;</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Une valeur parmi once, request, conn, thread -- la valeur par d&#233;faut est once</td></tr>
<tr><th><a href="directive-dict.html#Syntax">Syntaxe:</a></th><td><code>LuaScope once|request|conn|thread|server [min] [max]</code></td></tr>
<tr><th><a href="directive-dict.html#Default">D&#233;faut:</a></th><td><code>LuaScope once</code></td></tr>
<tr><th><a href="directive-dict.html#Context">Contexte:</a></th><td>configuration globale, serveur virtuel, r&#233;pertoire, .htaccess</td></tr>
<tr><th><a href="directive-dict.html#Override">Surcharges autoris&#233;es:</a></th><td>All</td></tr>
<tr><th><a href="directive-dict.html#Status">Statut:</a></th><td>Exp&#233;rimental</td></tr>
<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_lua</td></tr>
</table>
    <p>Cette directive permet de sp&#233;cifier la dur&#233;e de vie de
    l'interpr&#233;teur Lua qui sera utilis&#233; dans ce "r&#233;pertoire". La valeur
    par d&#233;faut est "once".</p>

   <dl>
    <dt>once:</dt> <dd>utilise l'interpr&#233;teur une fois.</dd>

    <dt>request:</dt> <dd>utilise l'interpr&#233;teur pour traiter tout ce
    qui est bas&#233; sur le m&#234;me fichier dans la requ&#234;te, et qui se trouve
    aussi dans la port&#233;e de la requ&#234;te.</dd>

    <dt>conn:</dt> <dd>idem request, mais attach&#233; &#224; connection_rec</dd>

    <dt>thread:</dt> <dd>Utilise l'interpr&#233;teur pendant toute la dur&#233;e
    de vie du thread qui traite la requ&#234;te (disponible seulement avec
    les MPMs thread&#233;s).</dd>

    <dt>server:</dt>  <dd>Le comportement est ici diff&#233;rent, car la
    port&#233;e du serveur pr&#233;sente une dur&#233;e de vie assez longue, et
    plusieurs threads vont partager le m&#234;me server_rec. Pour g&#233;rer tout
    ceci, les &#233;tats lua du serveur sont stock&#233;s dans une liste de ressources
    apr. Les arguments <code>min</code> et <code>max</code> permettent
    de sp&#233;cifier les nombres minimaux et maximaux d'&#233;tats lua &#224; stocker
    dans la liste.</dd>
   </dl>
   <p>En g&#233;n&#233;ral, les port&#233;es <code>thread</code> et <code>server</code>
   sont 2 &#224; 3 fois plus rapides que les autres, car elles n'ont pas besoin
   de r&#233;g&#233;n&#233;rer de nouveaux &#233;tats Lua &#224; chaque requ&#234;te (comme c'est le
   cas avec le MPM event, o&#249; m&#234;me les connexions persistantes utilisent un
   nouveau thread pour chaque requ&#234;te). Si vous pensez que vos scripts
   n'auront pas de probl&#232;me s'il r&#233;utilisent un &#233;tat, alors les port&#233;es
   <code>thread</code> ou <code>server</code> doivent &#234;tre utilis&#233;es car
   elles pr&#233;senteront de meilleures performances. Alors que la port&#233;e
   <code>thread</code> fournira les r&#233;ponses les plus rapides, la port&#233;e
   <code>server</code> utilisera moins de m&#233;moire car les &#233;tats sont
   rassembl&#233;s dans des jeux, permettant par exemple &#224; 1000 threads de
   partager 100 &#233;tats Lua, ne n&#233;cessitant ainsi que 10% de la m&#233;moire
   requise par la port&#233;e <code>thread</code>.
    </p>

</div>
</div>
<div class="bottomlang">
<p><span>Langues Disponibles: </span><a href="../en/mod/mod_lua.html" hreflang="en" rel="alternate" title="English">&nbsp;en&nbsp;</a> |
<a href="../fr/mod/mod_lua.html" title="Fran&#231;ais">&nbsp;fr&nbsp;</a></p>
</div><div class="top"><a href="#page-header"><img src="../images/up.gif" alt="top" /></a></div><div class="section"><h2><a id="comments_section" name="comments_section">Commentaires</a></h2><div class="warning"><strong>Notice:</strong><br />This is not a Q&amp;A section. Comments placed here should be pointed towards suggestions on improving the documentation or server, and may be removed again by our moderators if they are either implemented or considered invalid/off-topic. Questions on how to manage the Apache HTTP Server should be directed at either our IRC channel, #httpd, on Freenode, or sent to our <a href="http://httpd.apache.org/lists.html">mailing lists</a>.</div>
<script type="text/javascript"><!--//--><![CDATA[//><!--
var comments_shortname = 'httpd';
var comments_identifier = 'http://httpd.apache.org/docs/trunk/mod/mod_lua.html';
(function(w, d) {
    if (w.location.hostname.toLowerCase() == "httpd.apache.org") {
        d.write('<div id="comments_thread"><\/div>');
        var s = d.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = 'https://comments.apache.org/show_comments.lua?site=' + comments_shortname + '&page=' + comments_identifier;
        (d.getElementsByTagName('head')[0] || d.getElementsByTagName('body')[0]).appendChild(s);
    }
    else {
        d.write('<div id="comments_thread">Comments are disabled for this page at the moment.<\/div>');
    }
})(window, document);
//--><!]]></script></div><div id="footer">
<p class="apache">Copyright 2018 The Apache Software Foundation.<br />Autoris&#233; sous <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.</p>
<p class="menu"><a href="../mod/">Modules</a> | <a href="../mod/quickreference.html">Directives</a> | <a href="http://wiki.apache.org/httpd/FAQ">FAQ</a> | <a href="../glossary.html">Glossaire</a> | <a href="../sitemap.html">Plan du site</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>
</body></html>